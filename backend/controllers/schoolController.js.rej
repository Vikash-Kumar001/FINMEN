diff a/backend/controllers/schoolController.js b/backend/controllers/schoolController.js	(rejected hunks)
@@ -10,6 +10,7 @@ import ActivityLog from '../models/ActivityLog.js';
 import MoodLog from '../models/MoodLog.js';
 import Notification from '../models/Notification.js';
 import Assignment from '../models/Assignment.js';
+import AssignmentAttempt from '../models/AssignmentAttempt.js';
 import Timetable from '../models/Timetable.js';
 import Announcement from '../models/Announcement.js';
 import Template from '../models/Template.js';
@@ -434,7 +435,7 @@ export const createTeacher = async (req, res) => {
   try {
     const { tenantId } = req;
     const orgId = req.user?.orgId;
-    const { name, email, phone, subject, qualification, experience, joiningDate, password } = req.body;
+    const { name, email, phone, subject, qualification, experience, joiningDate, password, pronouns, customPronouns } = req.body;
 
     if (!name || !email || !subject) {
       return res.status(400).json({ message: 'Missing required fields: name, email, and subject are required' });
@@ -452,6 +453,9 @@ export const createTeacher = async (req, res) => {
     console.log('Creating teacher with password:', defaultPassword);
     const hashedPassword = await bcrypt.hash(defaultPassword, 10);
     
+    // Determine final pronouns value
+    const finalPronouns = pronouns === 'other' ? customPronouns : pronouns;
+
     const teacher = await User.create({
       name,
       email,
@@ -461,6 +465,7 @@ export const createTeacher = async (req, res) => {
       orgId,
       phone,
       subject,
+      pronouns: finalPronouns || '',
       metadata: {
         qualification: qualification || '',
         experience: parseInt(experience) || 0,
@@ -492,7 +497,8 @@ export const createTeacher = async (req, res) => {
         name: teacher.name,
         email: teacher.email,
         subject: teacher.subject,
-        phone: teacher.phone
+        phone: teacher.phone,
+        pronouns: teacher.pronouns
       }
     });
   } catch (error) {
@@ -650,9 +656,12 @@ export const getTeacherClasses = async (req, res) => {
   try {
     const { tenantId, user, isLegacyUser } = req;
 
-    // Build query based on user type
+    // Build query based on user type - check both classTeacher and subject teachers
     const query = {
-      'sections.classTeacher': user._id
+      $or: [
+        { 'sections.classTeacher': user._id },
+        { 'subjects.teachers': user._id }
+      ]
     };
     
     // Add tenantId filter for multi-tenant users
@@ -664,52 +673,69 @@ export const getTeacherClasses = async (req, res) => {
 
     const classes = await SchoolClass.find(query)
       .populate('sections.classTeacher', 'name email')
-      .select('classNumber stream sections academicYear')
+      .populate('subjects.teachers', 'name email')
+      .select('classNumber stream sections subjects academicYear isActive')
       .catch(err => {
         console.error('SchoolClass query error:', err);
         return [];
       });
 
-    // If no classes found, return mock data for demo purposes
+    // If no classes found where teacher is assigned, get all active classes for the school
     if (classes.length === 0) {
-      return res.json([
-        {
-          _id: 'mock-class-1',
-          name: 'Class 10A',
-          students: 42,
-          sections: 2,
-          academicYear: '2024-25',
-          avg: 85
-        },
-        {
-          _id: 'mock-class-2',
-          name: 'Class 9B',
-          students: 38,
-          sections: 2,
-          academicYear: '2024-25',
-          avg: 82
-        },
-        {
-          _id: 'mock-class-3',
-          name: 'Class 8A',
-          students: 35,
-          sections: 1,
-          academicYear: '2024-25',
-          avg: 88
-        }
-      ]);
+      console.log('No classes found for teacher, fetching all available classes');
+      
+      // Get all active classes for the school
+      const allClassesQuery = {
+        isActive: true
+      };
+      
+      if (!isLegacyUser && tenantId) {
+        allClassesQuery.tenantId = tenantId;
+      } else if (isLegacyUser) {
+        allClassesQuery.allowLegacy = true;
+      }
+
+      const allClasses = await SchoolClass.find(allClassesQuery)
+        .populate('sections.classTeacher', 'name email')
+        .populate('subjects.teachers', 'name email')
+        .select('classNumber stream sections subjects academicYear isActive')
+        .limit(10); // Limit to 10 classes to avoid overwhelming the UI
+
+      // Transform the classes to include proper names and IDs
+      const transformedClasses = allClasses.map(cls => ({
+        _id: cls._id,
+        name: `Class ${cls.classNumber}${cls.stream ? ` ${cls.stream}` : ''}`,
+        classNumber: cls.classNumber,
+        stream: cls.stream,
+        sections: cls.sections,
+        subjects: cls.subjects,
+        academicYear: cls.academicYear,
+        isActive: cls.isActive
+      }));
+
+      return res.json({
+        success: true,
+        classes: transformedClasses,
+        message: 'Showing all available classes. Contact admin to assign you to specific classes.'
+      });
     }
 
-    const classesWithStats = classes.map(cls => ({
+    // Transform the classes to include proper names and IDs
+    const transformedClasses = classes.map(cls => ({
       _id: cls._id,
       name: `Class ${cls.classNumber}${cls.stream ? ` ${cls.stream}` : ''}`,
-      students: cls.sections.reduce((sum, section) => sum + section.currentStrength, 0),
-      sections: cls.sections.length,
+      classNumber: cls.classNumber,
+      stream: cls.stream,
+      sections: cls.sections,
+      subjects: cls.subjects,
       academicYear: cls.academicYear,
-      avg: 85 // TODO: Calculate from student performance
+      isActive: cls.isActive
     }));
 
-    res.json(classesWithStats);
+    res.json({
+      success: true,
+      classes: transformedClasses
+    });
   } catch (error) {
     console.error('Error fetching teacher classes:', error);
     res.status(500).json({ message: 'Server error', error: error.message });
@@ -720,20 +746,84 @@ export const getTeacherClasses = async (req, res) => {
 export const getTeacherAssignments = async (req, res) => {
   try {
     const { tenantId, user } = req;
+    const { type, status, search } = req.query;
 
-    const assignments = await Assignment.find({
+    // Build query filters
+    const query = {
       tenantId,
       teacherId: user._id,
-      isActive: true
-    })
+      isActive: true,
+      hiddenFromTeacher: { $ne: true } // Exclude assignments hidden from teacher
+    };
+
+    if (type && type !== 'all') {
+      query.type = type;
+    }
+
+    if (status && status !== 'all') {
+      query.status = status;
+    }
+
+    if (search) {
+      query.$or = [
+        { title: { $regex: search, $options: 'i' } },
+        { description: { $regex: search, $options: 'i' } },
+        { subject: { $regex: search, $options: 'i' } }
+      ];
+    }
+
+    const assignments = await Assignment.find(query)
+      .populate('classId', 'name section academicYear')
+      .populate('assignedToClasses', 'name section academicYear')
       .sort({ dueDate: 1 })
-      .limit(10)
       .lean();
 
-    res.json(assignments);
+    // Get basic stats for each assignment
+    const assignmentsWithStats = await Promise.all(
+      assignments.map(async (assignment) => {
+        const AssignmentAttempt = (await import('../models/AssignmentAttempt.js')).default;
+        
+        const totalAttempts = await AssignmentAttempt.countDocuments({
+          assignmentId: assignment._id,
+          tenantId
+        });
+
+        const submittedAttempts = await AssignmentAttempt.countDocuments({
+          assignmentId: assignment._id,
+          tenantId,
+          status: 'submitted'
+        });
+
+        const averageScore = await AssignmentAttempt.aggregate([
+          { $match: { assignmentId: assignment._id, tenantId, status: 'submitted' } },
+          { $group: { _id: null, avgScore: { $avg: '$totalScore' } } }
+        ]);
+
+        return {
+          ...assignment,
+          stats: {
+            totalAttempts,
+            submittedAttempts,
+            pendingAttempts: totalAttempts - submittedAttempts,
+            completionRate: totalAttempts > 0 ? Math.round((submittedAttempts / totalAttempts) * 100) : 0,
+            averageScore: averageScore.length > 0 ? Math.round(averageScore[0].avgScore * 100) / 100 : 0
+          }
+        };
+      })
+    );
+
+    res.json({
+      success: true,
+      data: assignmentsWithStats,
+      total: assignmentsWithStats.length
+    });
   } catch (error) {
     console.error('Error fetching teacher assignments:', error);
-    res.status(500).json({ message: 'Server error' });
+    res.status(500).json({ 
+      success: false,
+      message: 'Failed to fetch assignments',
+      error: error.message 
+    });
   }
 };
 
@@ -899,24 +989,52 @@ export const getStudentGrades = async (req, res) => {
   }
 };
 
-// Student Announcements
+// Student Announcements - Redirect to announcement controller
 export const getStudentAnnouncements = async (req, res) => {
   try {
-    // Mock data - in real app, this would come from Announcement model
-    const announcements = [
-      {
-        title: 'Holiday Notice',
-        message: 'School will be closed on January 26th for Republic Day',
-        date: '2024-01-20'
-      },
-      {
-        title: 'Exam Schedule',
-        message: 'Mid-term exams will start from February 1st',
-        date: '2024-01-18'
-      }
-    ];
+    const { tenantId, user } = req;
+    const { page = 1, limit = 10 } = req.query;
 
-    res.json(announcements);
+    // Get student's class information
+    const student = await User.findById(user._id).populate('academic.classId');
+    const studentClassId = student.academic?.classId?._id;
+
+    // Build filter for announcements visible to students
+    const filter = {
+      tenantId,
+      isActive: true,
+      $or: [
+        { targetAudience: 'all' },
+        { targetAudience: 'students' },
+        ...(studentClassId ? [{ targetClasses: studentClassId }] : [])
+      ],
+      $and: [
+        { publishDate: { $lte: new Date() } },
+        {
+          $or: [
+            { expiryDate: { $exists: false } },
+            { expiryDate: null },
+            { expiryDate: { $gte: new Date() } }
+          ]
+        }
+      ]
+    };
+
+    const announcements = await Announcement.find(filter)
+      .populate('createdBy', 'name email avatar')
+      .populate('targetClasses', 'classNumber stream')
+      .sort({ isPinned: -1, publishDate: -1 })
+      .limit(limit * 1)
+      .skip((page - 1) * limit);
+
+    const total = await Announcement.countDocuments(filter);
+
+    res.json({
+      announcements,
+      totalPages: Math.ceil(total / limit),
+      currentPage: page,
+      total
+    });
   } catch (error) {
     console.error('Error fetching student announcements:', error);
     res.status(500).json({ message: 'Server error' });
@@ -1070,24 +1188,47 @@ export const getParentFees = async (req, res) => {
   }
 };
 
-// Parent Announcements
+// Parent Announcements - Updated to use actual data
 export const getParentAnnouncements = async (req, res) => {
   try {
-    // Mock data - in real app, this would come from Announcement model
-    const announcements = [
-      {
-        title: 'Parent-Teacher Meeting',
-        message: 'PTM scheduled for Class 10A on January 25th at 2 PM',
-        date: '2024-01-20'
-      },
-      {
-        title: 'Fee Payment Reminder',
-        message: 'Please pay the pending fees before the due date',
-        date: '2024-01-18'
-      }
-    ];
+    const { tenantId } = req;
+    const { page = 1, limit = 10 } = req.query;
+
+    // Build filter for announcements visible to parents
+    const filter = {
+      tenantId,
+      isActive: true,
+      $or: [
+        { targetAudience: 'all' },
+        { targetAudience: 'parents' }
+      ],
+      $and: [
+        { publishDate: { $lte: new Date() } },
+        {
+          $or: [
+            { expiryDate: { $exists: false } },
+            { expiryDate: null },
+            { expiryDate: { $gte: new Date() } }
+          ]
+        }
+      ]
+    };
+
+    const announcements = await Announcement.find(filter)
+      .populate('createdBy', 'name email avatar')
+      .populate('targetClasses', 'classNumber stream')
+      .sort({ isPinned: -1, publishDate: -1 })
+      .limit(limit * 1)
+      .skip((page - 1) * limit);
 
-    res.json(announcements);
+    const total = await Announcement.countDocuments(filter);
+
+    res.json({
+      announcements,
+      totalPages: Math.ceil(total / limit),
+      currentPage: page,
+      total
+    });
   } catch (error) {
     console.error('Error fetching parent announcements:', error);
     res.status(500).json({ message: 'Server error' });
@@ -1180,7 +1321,7 @@ export const getStudentAnalyticsForTeacher = async (req, res) => {
       return res.status(400).json({ message: 'Student ID is required' });
     }
 
-    // Fetch student data
+    // Fetch student data with parent information
     const student = await User.findById(studentId).select('name email role tenantId createdAt dob avatar academic institution linkedIds').lean();
 
     if (!student) {
@@ -1192,6 +1333,23 @@ export const getStudentAnalyticsForTeacher = async (req, res) => {
       return res.status(403).json({ message: 'Access denied to this student' });
     }
 
+    // Fetch parent information
+    let parentInfo = null;
+    if (student.linkedIds && student.linkedIds.parentIds && student.linkedIds.parentIds.length > 0) {
+      const parent = await User.findById(student.linkedIds.parentIds[0])
+        .select('name email phone avatar')
+        .lean();
+      
+      if (parent) {
+        parentInfo = {
+          name: parent.name,
+          email: parent.email,
+          phone: parent.phone,
+          avatar: parent.avatar || '/avatars/avatar1.png'
+        };
+      }
+    }
+
     const thirtyDaysAgo = new Date();
     thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
     
@@ -1562,14 +1720,24 @@ export const getStudentAnalyticsForTeacher = async (req, res) => {
       aiSkills: totalCompleted > 0 ? Math.round((categoryCounts['AI Skills'] || 0) / totalCompleted * 100) : 18
     };
 
-    // 16. Child Card Info (SAME AS PARENT)
+    // 16. Child Card Info with Parent Information
     const childCard = {
       name: student.name,
       avatar: student.avatar || '/avatars/avatar1.png',
       email: student.email,
       grade: student.academic?.grade || student.institution || 'Not specified',
       age: student.dob ? Math.floor((Date.now() - new Date(student.dob)) / (365.25 * 24 * 60 * 60 * 1000)) : null,
-      teacherContact: null // Teacher viewing student, so no teacher contact shown
+      parentContact: parentInfo ? {
+        name: parentInfo.name,
+        email: parentInfo.email,
+        phone: parentInfo.phone || 'Not provided',
+        avatar: parentInfo.avatar
+      } : {
+        name: 'Not specified',
+        email: 'Not specified',
+        phone: 'Not specified',
+        avatar: '/avatars/avatar1.png'
+      }
     };
 
     // 17. Snapshot KPIs (SAME AS PARENT)
@@ -2115,25 +2283,130 @@ export const createAssignment = async (req, res) => {
     const { tenantId, user } = req;
     const assignmentData = req.body;
 
+    console.log('Creating assignment with data:', assignmentData);
+
+    // Validate required fields
+    if (!assignmentData.title || !assignmentData.description || !assignmentData.subject || !assignmentData.dueDate) {
+      return res.status(400).json({
+        success: false,
+        message: 'Missing required fields: title, description, subject, and dueDate are required'
+      });
+    }
+
+    if (!assignmentData.assignedTo || assignmentData.assignedTo.length === 0) {
+      return res.status(400).json({
+        success: false,
+        message: 'At least one class must be selected'
+      });
+    }
+
     // Get orgId if available
     let orgId = user.orgId || null;
     if (!orgId && tenantId) {
-      const org = await Organization.findOne({ tenantId });
-      if (org) {
-        orgId = org._id;
+      try {
+        const org = await Organization.findOne({ tenantId });
+        if (org) {
+          orgId = org._id;
+        }
+      } catch (orgError) {
+        console.error('Error fetching organization:', orgError);
+        // Continue without orgId
+      }
+    }
+
+    // Get class information if classId is provided
+    let className = 'Multiple Classes';
+    let classId = null;
+    
+    if (assignmentData.assignedTo && assignmentData.assignedTo.length > 0) {
+      try {
+        // If only one class is selected, get its details
+        if (assignmentData.assignedTo.length === 1) {
+          const classInfo = await SchoolClass.findById(assignmentData.assignedTo[0]);
+          if (classInfo) {
+            className = `Class ${classInfo.classNumber}${classInfo.stream ? ` ${classInfo.stream}` : ''}`;
+            classId = classInfo._id;
+          } else {
+            console.warn('Class not found for ID:', assignmentData.assignedTo[0]);
+            className = 'Unknown Class';
+          }
+        } else {
+          // Multiple classes selected
+          className = `${assignmentData.assignedTo.length} Classes`;
+        }
+      } catch (classError) {
+        console.error('Error fetching class information:', classError);
+        className = 'Multiple Classes';
       }
     }
 
     const assignmentToCreate = {
-      ...assignmentData,
+      title: assignmentData.title,
+      description: assignmentData.description,
+      subject: assignmentData.subject,
+      type: assignmentData.type || 'homework',
+      dueDate: new Date(assignmentData.dueDate),
+      totalMarks: assignmentData.totalPoints || assignmentData.points || 100,
+      priority: assignmentData.priority || 'medium',
+      status: 'published',
+      className: className,
+      classId: classId,
+      assignedToClasses: assignmentData.assignedTo || [], // Store all assigned class IDs
       tenantId: tenantId || 'default',
-      teacherId: user._id
+      teacherId: user._id,
+      assignedDate: new Date(),
+      isActive: true,
+      // New fields for template-based assignments
+      questions: (assignmentData.questions || []).map(q => {
+        console.log('ðŸ” Processing question:', {
+          type: q.type,
+          question: q.question,
+          options: q.options,
+          optionsType: typeof q.options,
+          isArray: Array.isArray(q.options)
+        });
+        
+        // For project assignments, provide default question text if empty
+        if (assignmentData.type === 'project' && !q.question && ['research_question', 'presentation', 'reflection'].includes(q.type)) {
+          return {
+            ...q,
+            question: q.type === 'research_question' ? 'Research Task' : 
+                     q.type === 'presentation' ? 'Presentation Task' : 
+                     'Reflection Task'
+          };
+        }
+        
+        // Ensure options is properly formatted
+        if (q.options && Array.isArray(q.options)) {
+          // If options are strings (multiple choice), keep them as strings
+          // If options are objects (matching), keep them as objects
+          q.options = q.options.filter(opt => opt && opt.toString().trim() !== '');
+        }
+        
+        return q;
+      }),
+      questionCount: assignmentData.questionCount || 0,
+      instructions: assignmentData.instructions || "Complete all questions carefully.",
+      gradingType: assignmentData.gradingType || "auto",
+      allowRetake: assignmentData.allowRetake !== false,
+      maxAttempts: assignmentData.maxAttempts || 3,
+      duration: assignmentData.duration || 60, // in minutes
+      // Project-specific fields
+      projectMode: assignmentData.projectMode || 'instructions',
+      projectData: assignmentData.projectData || {}
     };
 
     if (orgId) {
       assignmentToCreate.orgId = orgId;
     }
 
+    // Add attachments if provided
+    if (assignmentData.attachments && assignmentData.attachments.length > 0) {
+      assignmentToCreate.attachments = assignmentData.attachments;
+    }
+
+    console.log('Assignment to create:', assignmentToCreate);
+
     const assignment = await Assignment.create(assignmentToCreate);
 
     res.status(201).json({ 
@@ -2175,15 +2448,54 @@ export const updateAssignment = async (req, res) => {
   }
 };
 
-// Delete Assignment/Task
-export const deleteAssignment = async (req, res) => {
+// Delete Assignment for Teacher Only (Soft Delete)
+export const deleteAssignmentForTeacher = async (req, res) => {
+  try {
+    const { tenantId, user } = req;
+    const { assignmentId } = req.params;
+
+    const assignment = await Assignment.findOneAndUpdate(
+      { _id: assignmentId, tenantId, teacherId: user._id },
+      { 
+        hiddenFromTeacher: true,
+        deletedBy: user._id,
+        deletedAt: new Date(),
+        deleteType: 'soft_teacher'
+      },
+      { new: true }
+    );
+
+    if (!assignment) {
+      return res.status(404).json({ message: 'Assignment not found' });
+    }
+
+    res.json({ 
+      success: true,
+      message: 'Assignment deleted for you. Students can still see and access it.',
+      deleteType: 'soft_teacher'
+    });
+  } catch (error) {
+    console.error('Error deleting assignment for teacher:', error);
+    res.status(500).json({ message: 'Server error', error: error.message });
+  }
+};
+
+// Delete Assignment for Everyone (Hard Delete)
+export const deleteAssignmentForEveryone = async (req, res) => {
   try {
     const { tenantId, user } = req;
     const { assignmentId } = req.params;
 
     const assignment = await Assignment.findOneAndUpdate(
       { _id: assignmentId, tenantId, teacherId: user._id },
-      { isActive: false },
+      { 
+        isActive: false,
+        hiddenFromStudents: true,
+        hiddenFromTeacher: true,
+        deletedBy: user._id,
+        deletedAt: new Date(),
+        deleteType: 'hard'
+      },
       { new: true }
     );
 
@@ -2191,13 +2503,105 @@ export const deleteAssignment = async (req, res) => {
       return res.status(404).json({ message: 'Assignment not found' });
     }
 
-    res.json({ message: 'Assignment deleted successfully' });
+    // Also delete any related assignment attempts
+    await AssignmentAttempt.updateMany(
+      { assignmentId: assignmentId, tenantId },
+      { isActive: false }
+    );
+
+    res.json({ 
+      success: true,
+      message: 'Assignment deleted for everyone. No one can access it anymore.',
+      deleteType: 'hard'
+    });
+  } catch (error) {
+    console.error('Error deleting assignment for everyone:', error);
+    res.status(500).json({ message: 'Server error', error: error.message });
+  }
+};
+
+// Delete Assignment for Student (Soft Delete)
+export const deleteAssignmentForStudent = async (req, res) => {
+  try {
+    const { tenantId, user } = req;
+    const { assignmentId } = req.params;
+
+    // Check if student has submitted this assignment
+    const submittedAttempt = await AssignmentAttempt.findOne({
+      assignmentId: assignmentId,
+      studentId: user._id,
+      tenantId,
+      status: 'submitted'
+    });
+
+    if (!submittedAttempt) {
+      return res.status(400).json({ 
+        success: false,
+        message: 'You can only delete assignments after submitting them' 
+      });
+    }
+
+    // Add student to hidden list for this assignment
+    const assignment = await Assignment.findById(assignmentId);
+    if (!assignment) {
+      return res.status(404).json({ message: 'Assignment not found' });
+    }
+
+    // Add student to hiddenFromStudents list (we'll use a new field for this)
+    if (!assignment.hiddenFromStudentsList) {
+      assignment.hiddenFromStudentsList = [];
+    }
+    
+    if (!assignment.hiddenFromStudentsList.includes(user._id.toString())) {
+      assignment.hiddenFromStudentsList.push(user._id.toString());
+      await assignment.save();
+    }
+
+    res.json({ 
+      success: true,
+      message: 'Assignment removed from your view. You can still access it from your submission history.',
+      deleteType: 'soft_student'
+    });
   } catch (error) {
-    console.error('Error deleting assignment:', error);
+    console.error('Error deleting assignment for student:', error);
     res.status(500).json({ message: 'Server error', error: error.message });
   }
 };
 
+// Get Single Assignment by ID
+export const getAssignmentById = async (req, res) => {
+  try {
+    const { tenantId } = req;
+    const { assignmentId } = req.params;
+
+    const assignment = await Assignment.findOne({
+      _id: assignmentId,
+      tenantId,
+      isActive: true
+    })
+    .populate('teacherId', 'name email')
+    .populate('classId', 'name section academicYear');
+
+    if (!assignment) {
+      return res.status(404).json({ 
+        success: false,
+        message: 'Assignment not found' 
+      });
+    }
+
+    res.json({
+      success: true,
+      data: assignment
+    });
+  } catch (error) {
+    console.error('Error getting assignment:', error);
+    res.status(500).json({ 
+      success: false,
+      message: 'Server error' 
+    });
+  }
+};
+
 // Mark message as read
 export const markMessageAsRead = async (req, res) => {
   try {
@@ -2761,15 +3165,47 @@ export const assignStudentsToClass = async (req, res) => {
   try {
     const { classId, className, studentIds } = req.body;
     const teacherId = req.user._id;
+    const { tenantId } = req;
 
     if (!studentIds || studentIds.length === 0) {
       return res.status(400).json({ message: 'No students selected' });
     }
 
-    // Update each student's class information
+    // Get class details
+    const classData = await SchoolClass.findOne({ _id: classId, tenantId });
+    if (!classData) {
+      return res.status(404).json({ message: 'Class not found' });
+    }
+
+    // Determine section - use first available section
+    const targetSection = classData.sections[0]?.name;
+    if (!targetSection) {
+      return res.status(400).json({ message: 'No sections available in this class' });
+    }
+
+    // Check for students already assigned to other classes
+    const studentsAlreadyAssigned = await SchoolStudent.find({
+      userId: { $in: studentIds },
+      tenantId,
+      classId: { $ne: classId, $ne: null }
+    }).populate('classId', 'classNumber');
+
+    if (studentsAlreadyAssigned.length > 0) {
+      const errorMessages = studentsAlreadyAssigned.map(student => 
+        `${student.name || 'Student'} is already assigned to Class ${student.classId?.classNumber || 'Unknown'}`
+      );
+      return res.status(400).json({ 
+        message: 'Some students are already assigned to other classes',
+        errors: errorMessages,
+        studentsAlreadyAssigned: studentsAlreadyAssigned.map(s => s.userId)
+      });
+    }
+
+    // Update both User and SchoolStudent models
     await Promise.all(
-      studentIds.map(studentId =>
-        User.findByIdAndUpdate(studentId, {
+      studentIds.map(async (studentId) => {
+        // Update User model
+        await User.findByIdAndUpdate(studentId, {
           $addToSet: {
             'metadata.classes': {
               classId,
@@ -2778,10 +3214,50 @@ export const assignStudentsToClass = async (req, res) => {
               assignedAt: new Date()
             }
           }
-        })
-      )
+        });
+
+        // Update or create SchoolStudent record
+        await SchoolStudent.findOneAndUpdate(
+          { userId: studentId, tenantId },
+          {
+            classId: classId,
+            grade: classData.classNumber,
+            section: targetSection,
+            academicYear: classData.academicYear
+          },
+          { upsert: true, new: true }
+        );
+      })
     );
 
+    // Update section strength
+    const sectionIndex = classData.sections.findIndex(s => s.name === targetSection);
+    if (sectionIndex !== -1) {
+      const currentCount = await SchoolStudent.countDocuments({
+        tenantId,
+        classId,
+        section: targetSection
+      });
+      classData.sections[sectionIndex].currentStrength = currentCount;
+      await classData.save();
+    }
+
+    // Log audit
+    await ComplianceAuditLog.logAction({
+      tenantId,
+      orgId: req.user?.orgId,
+      userId: req.user._id,
+      userRole: req.user.role,
+      userName: req.user.name,
+      action: 'students_assigned_to_class_by_teacher',
+      targetType: 'class',
+      targetId: classId,
+      targetName: `Class ${classData.classNumber}`,
+      description: `${studentIds.length} student(s) assigned to Class ${classData.classNumber} - Section ${targetSection} by teacher`,
+      ipAddress: req.ip,
+      userAgent: req.headers['user-agent'],
+    });
+
     res.json({
       success: true,
       message: `${studentIds.length} student(s) assigned to ${className}`,
@@ -2962,97 +3438,6 @@ export const bulkUploadStudents = async (req, res) => {
   }
 };
 
-// Assignment Wizard Endpoints
-
-// Get assignment templates
-export const getAssignmentTemplates = async (req, res) => {
-  try {
-    const { tenantId } = req;
-    
-    // Mock templates for now - in production, fetch from database
-    const templates = [
-      {
-        _id: "1",
-        title: "Math Quiz - Algebra Basics",
-        description: "15 questions covering basic algebra concepts",
-        category: "math",
-        subject: "Mathematics",
-        questionCount: 15,
-        duration: 30,
-        premium: false
-      },
-      {
-        _id: "2",
-        title: "Science Test - Photosynthesis",
-        description: "Comprehensive test on photosynthesis",
-        category: "science",
-        subject: "Biology",
-        questionCount: 20,
-        duration: 45,
-        premium: false
-      },
-      {
-        _id: "3",
-        title: "English Grammar Assessment",
-        description: "Advanced grammar and composition",
-        category: "english",
-        subject: "English",
-        questionCount: 25,
-        duration: 40,
-        premium: true
-      }
-    ];
-
-    res.json({ success: true, templates });
-  } catch (error) {
-    console.error("Error fetching templates:", error);
-    res.status(500).json({ message: "Server error", error: error.message });
-  }
-};
-
-// Get question bank
-export const getQuestionBank = async (req, res) => {
-  try {
-    const { tenantId } = req;
-    
-    // Mock question bank - in production, fetch from database
-    const questions = [
-      {
-        _id: "q1",
-        title: "Algebra Fundamentals",
-        category: "Algebra",
-        questionCount: 30,
-        difficulty: "medium"
-      },
-      {
-        _id: "q2",
-        title: "Geometry Basics",
-        category: "Geometry",
-        questionCount: 25,
-        difficulty: "easy"
-      },
-      {
-        _id: "q3",
-        title: "Cell Biology",
-        category: "Biology",
-        questionCount: 40,
-        difficulty: "medium"
-      },
-      {
-        _id: "q4",
-        title: "Grammar Rules",
-        category: "English",
-        questionCount: 35,
-        difficulty: "hard"
-      }
-    ];
-
-    res.json({ success: true, questions });
-  } catch (error) {
-    console.error("Error fetching question bank:", error);
-    res.status(500).json({ message: "Server error", error: error.message });
-  }
-};
 
 // Get Inavora catalog
 export const getInavoraCatalog = async (req, res) => {
@@ -3204,134 +3589,6 @@ export const aiSuggestStudents = async (req, res) => {
   }
 };
 
-// Create advanced assignment
-export const createAdvancedAssignment = async (req, res) => {
-  try {
-    const { scope, template, modules, rules, participants, rewards, status } = req.body;
-    const teacherId = req.user._id;
-    const { tenantId, isLegacyUser } = req;
-
-    // Validate required fields
-    if (!scope || !template || !modules || !rules) {
-      return res.status(400).json({ 
-        success: false, 
-        message: "Missing required fields: scope, template, modules, and rules are required" 
-      });
-    }
-
-    // Get orgId if available
-    let orgId = req.user.orgId || null;
-    if (!orgId && tenantId) {
-      const org = await Organization.findOne({ tenantId });
-      if (org) {
-        orgId = org._id;
-      }
-    }
-
-    // Create assignment document
-    const assignmentData = {
-      title: template.title,
-      description: template.description,
-      subject: template.subject,
-      teacherId,
-      tenantId: tenantId || 'default-tenant',
-      className: typeof scope.classes[0] === 'object' ? scope.classes[0].name : (scope.classes[0] || 'General'),
-      
-      // Scope
-      scope: scope.type,
-      scopeClasses: scope.classes,
-      approvalRequired: scope.approvalRequired,
-      
-      // Template
-      templateType: template.type,
-      templateId: template.selectedTemplate?._id,
-      
-      // Modules
-      modules: modules.items.map(item => ({
-        type: item.type,
-        id: item._id || item.id,
-        title: item.title,
-        module_id: item._id || item.id,
-        questionCount: item.questionCount,
-        duration: item.duration
-      })),
-      
-      // Rules
-      startTime: new Date(rules.startTime),
-      endTime: new Date(rules.endTime),
-      dueDate: new Date(rules.endTime),
-      assignedDate: new Date(),
-      maxAttempts: rules.maxAttempts,
-      randomizeQuestions: rules.randomizeQuestions,
-      gradingType: rules.gradingType,
-      accessibility: rules.accessibility,
-      
-      // Participants
-      participantMode: participants.mode,
-      selectedStudents: participants.selectedStudents,
-      filterTags: participants.filterTags,
-      aiSuggestions: participants.aiSuggestions,
-      
-      // Rewards
-      healCoinsReward: rewards.healCoins * rewards.bonusMultiplier,
-      badges: rewards.badges,
-      certificate: rewards.certificate,
-      
-      // Status
-      status: scope.approvalRequired ? 'pending_approval' : (status || 'published'),
-      createdAt: new Date(),
-      updatedAt: new Date()
-    };
-
-    if (orgId) {
-      assignmentData.orgId = orgId;
-    }
-
-    const assignment = await Assignment.create(assignmentData);
-
-    // If requires approval, create approval task
-    if (scope.approvalRequired) {
-      // Create approval notification for admin
-      await Notification.create({
-        userId: orgId, // Send to org admin
-        type: 'approval_request',
-        title: 'Assignment Approval Required',
-        message: `Teacher ${req.user.name} has submitted "${template.title}" for approval`,
-        metadata: {
-          assignmentId: assignment._id,
-          teacherId,
-          scope: scope.type
-        }
-      });
-    }
-
-    res.json({
-      success: true,
-      message: scope.approvalRequired ? 'Assignment submitted for approval' : 'Assignment published successfully',
-      assignment
-    });
-  } catch (error) {
-    console.error("Error creating advanced assignment:", error);
-    console.error("Request body:", JSON.stringify(req.body, null, 2));
-    
-    // Return more specific error messages
-    if (error.name === 'ValidationError') {
-      const validationErrors = Object.values(error.errors).map(err => err.message);
-      return res.status(400).json({ 
-        success: false,
-        message: "Validation failed", 
-        errors: validationErrors,
-        details: error.errors
-      });
-    }
-    
-    res.status(500).json({ 
-      success: false,
-      message: "Server error", 
-      error: error.message 
-    });
-  }
-};
 
 // Helper function to format time ago
 const formatTimeAgo = (date) => {
@@ -7790,9 +8047,10 @@ export const addStudentsToClass = async (req, res) => {
       });
     }
 
-    // Update students
-    const updatePromises = studentIds.map(studentId =>
-      SchoolStudent.findOneAndUpdate(
+    // Update both SchoolStudent and User models
+    const updatePromises = studentIds.map(async (studentId) => {
+      // Update SchoolStudent model
+      const schoolStudent = await SchoolStudent.findOneAndUpdate(
         { _id: studentId, tenantId },
         {
           classId: classId,
@@ -7801,8 +8059,24 @@ export const addStudentsToClass = async (req, res) => {
           academicYear: classData.academicYear
         },
         { new: true }
-      )
-    );
+      );
+
+      // Update User model if SchoolStudent exists
+      if (schoolStudent && schoolStudent.userId) {
+        await User.findByIdAndUpdate(schoolStudent.userId, {
+          $addToSet: {
+            'metadata.classes': {
+              classId,
+              className: `Class ${classData.classNumber}`,
+              teacherId: null, // Admin assignment
+              assignedAt: new Date()
+            }
+          }
+        });
+      }
+
+      return schoolStudent;
+    });
 
     await Promise.all(updatePromises);
 
@@ -7940,29 +8214,31 @@ export const addStudentsByEmailToClass = async (req, res) => {
         } else {
           // Check if already assigned to this class
           if (schoolStudent.classId && schoolStudent.classId.toString() === classId) {
-            results.alreadyAssigned.push({ email, name: user.name });
-            continue;
-          }
-
-          // Check if already assigned to another class
-          if (schoolStudent.classId && schoolStudent.classId.toString() !== classId) {
-            const existingClass = await SchoolClass.findById(schoolStudent.classId);
-            results.errors.push({ 
-              email, 
-              error: `Student is already assigned to Class ${existingClass?.classNumber || 'Unknown'}. One student can only be assigned to one class.` 
-            });
+            results.alreadyAssigned.push({ email, message: 'Student already assigned to this class' });
             continue;
           }
 
-          // Update existing SchoolStudent
+          // Update existing SchoolStudent record
           schoolStudent.classId = classId;
+          schoolStudent.grade = classData.classNumber;
           schoolStudent.section = section;
           schoolStudent.academicYear = classData.academicYear;
           await schoolStudent.save();
-        }
 
-        results.success.push({ email, name: user.name, studentId: schoolStudent._id });
+          // Update User model
+          await User.findByIdAndUpdate(user._id, {
+            $addToSet: {
+              'metadata.classes': {
+                classId,
+                className: `Class ${classData.classNumber}`,
+                teacherId: null, // Admin assignment
+                assignedAt: new Date()
+              }
+            }
+          });
 
+          results.success.push({ email, studentId: schoolStudent._id });
+        }
       } catch (error) {
         console.error(`Error processing email ${email}:`, error);
         results.errors.push({ email, error: error.message });
@@ -7970,14 +8246,13 @@ export const addStudentsByEmailToClass = async (req, res) => {
     }
 
     // Update section strength
-    const currentCount = await SchoolStudent.countDocuments({
-      tenantId,
-      classId,
-      section: section
-    });
-    
     const sectionIndex = classData.sections.findIndex(s => s.name === section);
     if (sectionIndex !== -1) {
+      const currentCount = await SchoolStudent.countDocuments({
+        tenantId,
+        classId,
+        section: section
+      });
       classData.sections[sectionIndex].currentStrength = currentCount;
       await classData.save();
     }
@@ -7989,7 +8264,7 @@ export const addStudentsByEmailToClass = async (req, res) => {
       userId: req.user._id,
       userRole: req.user.role,
       userName: req.user.name,
-      action: 'students_added_by_email',
+      action: 'students_added_to_class_by_email',
       targetType: 'class',
       targetId: classId,
       targetName: `Class ${classData.classNumber}`,
@@ -8001,14 +8276,8 @@ export const addStudentsByEmailToClass = async (req, res) => {
     res.json({
       success: true,
       message: `Processed ${emails.length} email(s)`,
-      results: {
-        success: results.success.length,
-        errors: results.errors.length,
-        alreadyAssigned: results.alreadyAssigned.length,
-        details: results
-      }
+      results
     });
-
   } catch (error) {
     console.error('Error adding students by email:', error);
     res.status(500).json({ message: 'Server error', error: error.message });
@@ -8761,10 +9030,17 @@ export const createStudent = async (req, res) => {
   try {
     const { tenantId } = req;
     const orgId = req.user?.orgId;
-    const { name, email, phone, password, gender } = req.body;
+    const { name, email, phone, password, gender, dateOfBirth } = req.body;
+
+    if (!name || !email || !phone || !password || !gender || !dateOfBirth) {
+      return res.status(400).json({ message: 'Missing required fields: name, email, phone, gender, dateOfBirth, and password are required' });
+    }
 
-    if (!name || !email || !phone || !password || !gender) {
-      return res.status(400).json({ message: 'Missing required fields: name, email, phone, gender, and password are required' });
+    // Validate date of birth
+    const dob = new Date(dateOfBirth);
+    const today = new Date();
+    if (dob >= today) {
+      return res.status(400).json({ message: 'Date of birth cannot be in the future' });
     }
 
     // Check if user with email already exists
@@ -8816,6 +9092,8 @@ export const createStudent = async (req, res) => {
       tenantId,
       orgId,
       phone,
+      gender,
+      dateOfBirth: new Date(dateOfBirth),
     });
     
     console.log('Student created successfully:', {
@@ -8837,7 +9115,7 @@ export const createStudent = async (req, res) => {
       academicYear,
       parentIds: [], // Empty array - parents will link themselves later
       personalInfo: {
-        dateOfBirth: null,
+        dateOfBirth: new Date(dateOfBirth),
         gender: gender,
         bloodGroup: null,
       },
